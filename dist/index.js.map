{"version":3,"sources":["../src/index.js"],"names":["loadConsoles","loadEmulators","consoles","Promise","resolve","reject","then","emulators","getSteamConfigPath","users","readdirSync","length","console","error","filePath","loadShortcutsFile","join","shortcutFile","generateShortcuts","shortcutsFile","grids","each","gameConsole","name","emulator","getEmulator","games","game","gameShortcut","appname","prefix","cleanName","exe","getCommandForGame","icon","tags","replace","ignore","shortcut","addShortcut","push","gameName","consoleName","appid","getAppID","writeShortcuts","mapSeries","callback","existsSync","log","images","url","image","request","indexOf","get","response","file","createWriteStream","pipe","e","emulatorName","toLowerCase","addEmulator"],"mappings":"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","file":"index.js","sourcesContent":["import ShortcutFile from './shortcut-file';\r\nimport {findGridImages} from './grid-provider';\r\nimport {loadConfigObject} from './user-config';\r\nimport fs from 'fs';\r\nimport http from 'http';\r\nimport https from 'https';\r\nimport os from 'os';\r\nimport path from 'path';\r\nimport async from 'async';\r\nimport _ from 'lodash';\r\n\r\nimport GameConsole from './game-console';\r\nimport Emulator from './emulator';\r\n\r\nlet loadConsoles = () =>\r\n{\r\n    return loadConfigObject('consoles', GameConsole);\r\n}\r\n\r\nlet loadEmulators = (consoles) =>\r\n{\r\n    return new Promise((resolve, reject) =>\r\n    {\r\n        loadConfigObject('emulators', Emulator).then((emulators) => resolve({consoles: consoles, emulators: emulators}));\r\n    });\r\n}\r\n\r\nlet getSteamConfigPath = () =>\r\n{\r\n    let users = fs.readdirSync(\"C:/Program Files (x86)/Steam/userdata/\");\r\n\r\n    if (!users || !users.length)\r\n        console.error('No steam directory found !');\r\n\r\n    let filePath = \"C:/Program Files (x86)/Steam/userdata/\" + users[0] + \"/config\";\r\n\r\n    return filePath;\r\n}\r\n\r\nlet loadShortcutsFile = () =>\r\n{\r\n    return new Promise((resolve, reject) =>\r\n    {\r\n        let filePath = path.join(getSteamConfigPath(), 'shortcuts.vdf');\r\n\r\n        let shortcutFile = new ShortcutFile(filePath);\r\n\r\n        return resolve(shortcutFile);\r\n    });\r\n}\r\n\r\nlet generateShortcuts = (consoles, shortcutsFile) =>\r\n{\r\n    let grids = [];\r\n\r\n    _.each(consoles, (gameConsole, name) =>\r\n    {\r\n        let emulator = gameConsole.getEmulator();\r\n\r\n        if (!emulator)\r\n            return;\r\n\r\n        _.each(gameConsole.games, (game) =>\r\n        {\r\n            let gameShortcut = {\r\n                appname: gameConsole.prefix + ' ' + game.cleanName,\r\n                exe: emulator.getCommandForGame(game),\r\n                icon: gameConsole.icon,\r\n                tags: gameConsole.tags,\r\n            }\r\n\r\n            gameShortcut.appname = gameShortcut.appname.replace(/^ +/, '').replace(/ +$/, '');\r\n\r\n            if (!game.ignore)\r\n            {\r\n                let shortcut = shortcutsFile.addShortcut(gameShortcut);\r\n\r\n                grids.push({\r\n                    gameName: game.cleanName,\r\n                    consoleName: gameConsole.name,\r\n                    appid: shortcut.getAppID()\r\n                });\r\n            }\r\n        });\r\n    });\r\n\r\n    shortcutsFile.writeShortcuts();\r\n\r\n    async.mapSeries(\r\n        grids, \r\n        ({gameName, consoleName, appid}, callback) =>\r\n        {\r\n            let filePath = path.join(getSteamConfigPath(), 'grid', appid + '.png');\r\n\r\n            if (fs.existsSync(filePath))\r\n            {\r\n                console.log(`Grid image for ${gameName} already exists`);\r\n                return callback(null);\r\n            }\r\n\r\n            findGridImages(gameName, consoleName).then((images) => \r\n            {\r\n                if (images && images.length)\r\n                {\r\n                    let url = images[0].image;\r\n                    let request = (url.indexOf('https:') != -1) ? https : http;\r\n\r\n                    try\r\n                    {\r\n                        request.get(url, (response) =>\r\n                        {\r\n                            let file = fs.createWriteStream(filePath);\r\n\r\n                            console.log('Found grid for ' + gameName);\r\n\r\n                            response.pipe(file)\r\n                            return callback(null);\r\n                        });\r\n                    }\r\n                    catch(e)\r\n                    {\r\n                        console.log(`No grid image found for ${gameName}`);\r\n                        return callback(null);\r\n                    }\r\n                }\r\n                else\r\n                {\r\n                    console.log(`No grid image found for ${gameName}`);\r\n                    return callback(null);\r\n                }\r\n            });\r\n        }\r\n    );\r\n}\r\n\r\nloadConsoles().then(loadEmulators).then(({consoles, emulators}) =>\r\n{\r\n    _.each(emulators, (emulator, emulatorName) =>\r\n    {\r\n        _.each(emulator.consoles, (consoleName) =>\r\n        {\r\n            consoleName = consoleName.toLowerCase();\r\n            if (consoles[consoleName])\r\n                consoles[consoleName].addEmulator(emulatorName, emulator);\r\n        });\r\n    });\r\n\r\n    loadShortcutsFile().then((shortcutsFile) => {\r\n        generateShortcuts(consoles, shortcutsFile);\r\n    });\r\n});\r\n"]}